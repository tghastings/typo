<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <title><%= this_blog.blog_name %> â€“ <%= controller.controller_name %></title>
  <meta http-equiv="imagetoolbar" content="no" />
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "bootstrap", "administration_structure", "lightbox" %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <%= javascript_importmap_tags %>
  <%= javascript_include_tag "prototype", "builder", "effects", "controls", "dragdrop", "typo", "lightbox", "typo_carousel", "administration" %>
  <%= calendar_date_select_includes %>
  <style type="text/css">
    #carousel-content .slide { width: <%= this_blog.image_thumb_size %>; }

    /* Ensure editors are visible and properly sized */
    #visual_editor .rich-editor-wrapper { margin-bottom: 10px; }
    #visual_editor .ql-container { min-height: 300px; background: white; }
    #visual_editor .ql-editor { min-height: 300px; }
    #simple_editor textarea { min-height: 300px; width: 100%; background: white; }
    .ql-toolbar { background: #f3f3f3; border: 1px solid #ccc !important; }

    /* Fix footer positioning */
    footer {
      clear: both;
      position: relative;
      z-index: 1;
      margin-left: 220px; /* Same as sidebar width */
      padding: 20px;
      text-align: center;
      background: #f5f5f5;
      border-top: 1px solid #ddd;
    }
  </style>
  <script>
    // Fallback Quill initialization without Stimulus
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, checking for Quill editor...');

      // Editor initialization is handled by the form template
      // This is just a fallback for pages without the form's init script
      var visualEditor = document.getElementById('visual_editor');
      if (!visualEditor || visualEditor.style.display === 'none') {
        console.log('Visual editor not visible, skipping Quill initialization');
        return;
      }

      // Find editor container
      var editorContainer = document.querySelector('[data-rich-editor-target="editor"]');
      var hiddenInput = document.querySelector('[data-rich-editor-target="input"]');

      if (editorContainer && typeof Quill !== 'undefined') {
        console.log('Found editor container, creating Quill instance...');

        var quill = new Quill(editorContainer, {
          theme: 'snow',
          placeholder: 'Start writing...',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'indent': '-1'}, { 'indent': '+1' }],
              [{ 'align': [] }],
              ['blockquote', 'code-block'],
              ['link', 'image'],
              [{ 'color': [] }, { 'background': [] }],
              ['clean']
            ]
          }
        });

        console.log('Quill created!', quill);

        // Store reference for switchEditor
        editorContainer.quill = quill;
        window.quillEditor = quill;

        // Set initial content
        if (hiddenInput && hiddenInput.value) {
          quill.root.innerHTML = hiddenInput.value;
        }

        // Sync content to hidden input
        quill.on('text-change', function() {
          if (hiddenInput) {
            hiddenInput.value = quill.root.innerHTML;
          }
        });
      } else {
        console.log('No editor container found or Quill not loaded');
        console.log('Editor container:', editorContainer);
        console.log('Quill:', typeof Quill);
      }
    });
  </script>
</head>
<body>
  <div class='topbar'>
    <div class='topbar-inner'>
      <div class='container-fluid'>
        <%= link_to this_blog.blog_name, this_blog.base_url, { :class => 'brand' } %>
        <ul class="nav secondary-nav">
          <li class="dropdown">
            <a class="dropdown-toggle" href="#" onclick="var menu = this.nextElementSibling; menu.style.display = menu.style.display === 'none' ? 'block' : 'none'; return false;"><%= _("Logged in as %s", current_user.nickname)%></a>
            <ul class="dropdown-menu" style='display: none'>
              <li><%= link_to(_("New Article"), '/admin/content/new') %></li>
              <li><%= link_to _("Profile"), '/admin/profiles'  %></li>
              <li><%= link_to _("%s &raquo;", "Log out").html_safe, '/accounts/logout' %></li>
            </ul>
          </li>
        </ul>
        <ul class="nav secondary-nav">
          <li class="dropdown">
            <a class="dropdown-toggle" href="#" onclick="var menu = this.nextElementSibling; menu.style.display = menu.style.display === 'none' ? 'block' : 'none'; return false;"><%= _("Help")%></a>
            <ul class="dropdown-menu" style="display: none;">
              <li><%= link_to _("Documentation"), "https://github.com/fdv/typo/wiki" %></li>
              <li><%= link_to _("Report a bug"), "https://github.com/fdv/typo/issues" %></li>
              <li><%= link_to _("In page plugins"), "https://github.com/fdv/typo/wiki/In-Page-Plugins" %></li>
              <li><%= link_to _("Sidebar plugins"), "https://github.com/fdv/typo/wiki/Sidebar-plugins" %></li>
            </ul>
          </li>
        </ul>
				
      </div>
    </div>
  </div>
  <div class='container-fluid'>
    <div class='sidebar'>
      <div class='well'>
        <% if controller.controller_name == 'dashboard' %>
        <%= content_tag :h5, _('Dashboard')  %>
        <% else %>
        <%= content_tag :h5, (link_to _('Dashboard'), '/admin/dashboard')  %>
        <% end %>
        <% for pm in current_user.project_modules %>
        <%= content_tag :h5, (link_to _(pm.menus.first.name ), menu_url_to_path(pm.menus.first.url)), :class => send("class_#{pm.name}") %>
        <ul id='subtabs'>
          <%= subtabs_for(pm.name.to_sym)%>
        </ul>
        <% end %>
      </div>
    </div>
    <div class='content'>
      <div class=''>
        <%= render_the_flash %>
        <%= show_page_heading %>
        <%= yield  %>
      </div>
    </div>
  </div>

  <footer>
    <%= link_to(this_blog.blog_name, this_blog.base_url) %> <%= _("is proudly powered by")%> Typo <%=h TYPO_VERSION %>
  </footer>
</body>
</html>
