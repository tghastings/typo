<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <title><%= this_blog.blog_name %> â€“ <%= controller.controller_name %></title>
  <meta http-equiv="imagetoolbar" content="no" />
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag "bootstrap", "administration_structure", "lightbox" %>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:opsz,wght@8..60,400;8..60,500&display=swap" rel="stylesheet">

  <!-- CRITICAL: Protect native methods BEFORE Prototype.js loads -->
  <script>
    // Save native Array.from before Prototype.js can break it
    window._nativeArrayFrom = Array.from.bind(Array);

    // Protect Object.prototype - make any Prototype.js additions non-enumerable
    // We'll check after Prototype.js loads
    window._fixPrototypeJs = function() {
      // Fix Array.from if Prototype.js broke it
      var testSet = new Set([1, 2, 3]);
      if (Array.from(testSet).length === 0) {
        Array.from = function(iterable, mapFn, thisArg) {
          if (iterable == null) return [];
          // Try native first
          var result = window._nativeArrayFrom(iterable, mapFn, thisArg);
          if (result.length === 0 && iterable != null) {
            // Fallback for iterables
            if (typeof iterable[Symbol.iterator] === 'function') {
              try {
                result = [];
                for (var item of iterable) {
                  result.push(mapFn ? mapFn.call(thisArg, item) : item);
                }
              } catch (e) {}
            }
          }
          return result;
        };
        console.log('Array.from fixed after Prototype.js');
      }

      // Make Prototype.js Object.prototype additions non-enumerable
      ['inspect', 'toJSON', 'clone', 'toQueryString', 'keys', 'values'].forEach(function(method) {
        if (Object.prototype.hasOwnProperty(method)) {
          try {
            Object.defineProperty(Object.prototype, method, { enumerable: false });
          } catch (e) {}
        }
      });
    };
  </script>

  <%= javascript_include_tag "prototype", "builder", "effects", "controls", "dragdrop", "typo", "lightbox", "typo_carousel", "administration" %>

  <!-- Fix Prototype.js damage before Stimulus loads -->
  <script>window._fixPrototypeJs();</script>

  <!-- CodeMirror 5 for syntax highlighting (loaded globally for reliability) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/monokai.min.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/gfm/gfm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/ruby/ruby.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/mode/overlay.min.js"></script>

  <!-- Load importmap for Stimulus controllers -->
  <%= javascript_importmap_tags %>
  <%= calendar_date_select_includes %>
  <style type="text/css">
    #carousel-content .slide { width: <%= this_blog.image_thumb_size %>; }

    /* Markdown editor styles */
    .markdown-editor-container { margin-bottom: 15px; text-align: left; }
    .markdown-textarea {
      width: 100%;
      min-height: 400px;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
      font-size: 14px;
      line-height: 1.6;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      text-align: left;
    }
    /* CodeMirror text alignment fix */
    .CodeMirror, .CodeMirror-code, .CodeMirror pre, .editor-pane {
      text-align: left !important;
    }
    /* Grammarly support - ensure overlay is visible */
    .CodeMirror {
      position: relative;
      z-index: 1;
    }
    grammarly-extension, grammarly-popups {
      z-index: 9999 !important;
    }
    .markdown-toolbar {
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .toolbar-btn {
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
    }
    .toolbar-btn:hover { background: #e9e9e9; }
    .toolbar-group { display: flex; gap: 2px; margin-right: 10px; }
    .toolbar-label { font-size: 11px; color: #666; margin-right: 4px; align-self: center; }
    .preview-toggle { margin-left: auto; }
    .markdown-preview {
      padding: 15px;
      border: 1px solid #ccc;
      border-top: none;
      background: #fafafa;
      min-height: 200px;
    }
    .editor-pane { border-radius: 0 0 4px 4px; }

    /* Fix footer positioning */
    footer {
      clear: both;
      position: relative;
      z-index: 1;
      margin-left: 220px;
      padding: 20px;
      text-align: center;
      background: #f5f5f5;
      border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class='topbar'>
    <div class='topbar-inner'>
      <div class='container-fluid'>
        <%= link_to this_blog.blog_name, this_blog.base_url, { :class => 'brand' } %>
        <ul class="nav secondary-nav">
          <li class="dropdown">
            <a class="dropdown-toggle" href="#" onclick="var menu = this.nextElementSibling; menu.style.display = menu.style.display === 'none' ? 'block' : 'none'; return false;"><%= _("Logged in as %s", current_user.nickname)%></a>
            <ul class="dropdown-menu" style='display: none'>
              <li><%= link_to(_("New Article"), '/admin/content/new') %></li>
              <li><%= link_to _("Profile"), '/admin/profiles'  %></li>
              <li><%= link_to _("%s &raquo;", "Log out").html_safe, '/accounts/logout' %></li>
            </ul>
          </li>
        </ul>
        <ul class="nav secondary-nav">
          <li class="dropdown">
            <a class="dropdown-toggle" href="#" onclick="var menu = this.nextElementSibling; menu.style.display = menu.style.display === 'none' ? 'block' : 'none'; return false;"><%= _("Help")%></a>
            <ul class="dropdown-menu" style="display: none;">
              <li><%= link_to _("Documentation"), "https://github.com/fdv/typo/wiki" %></li>
              <li><%= link_to _("Report a bug"), "https://github.com/fdv/typo/issues" %></li>
              <li><%= link_to _("In page plugins"), "https://github.com/fdv/typo/wiki/In-Page-Plugins" %></li>
              <li><%= link_to _("Sidebar plugins"), "https://github.com/fdv/typo/wiki/Sidebar-plugins" %></li>
            </ul>
          </li>
        </ul>
				
      </div>
    </div>
  </div>
  <div class='container-fluid'>
    <div class='sidebar'>
      <div class='well'>
        <% if controller.controller_name == 'dashboard' %>
        <%= content_tag :h5, _('Dashboard')  %>
        <% else %>
        <%= content_tag :h5, (link_to _('Dashboard'), '/admin/dashboard')  %>
        <% end %>
        <% for pm in current_user.project_modules %>
        <%= content_tag :h5, (link_to _(pm.menus.first.name ), menu_url_to_path(pm.menus.first.url)), :class => send("class_#{pm.name}") %>
        <ul id='subtabs'>
          <%= subtabs_for(pm.name.to_sym)%>
        </ul>
        <% end %>
      </div>
    </div>
    <div class='content'>
      <div class=''>
        <%= render_the_flash %>
        <%= show_page_heading %>
        <%= yield  %>
      </div>
    </div>
  </div>

  <footer>
    <%= link_to(this_blog.blog_name, this_blog.base_url) %> <%= _("is proudly powered by")%> Typo of Theseus <%=h TYPO_VERSION %>
  </footer>
</body>
</html>
