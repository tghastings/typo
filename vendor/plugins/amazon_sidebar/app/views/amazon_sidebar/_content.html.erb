<% unless sidebar.products.blank? -%>
<h3 class="sidebar-title"><%= h sidebar.title %></h3>
<div class="amazon-carousel" data-interval="30000">
  <div class="amazon-carousel-inner">
<% sidebar.products.each_with_index do |(asin, info), index| -%>
    <div class="amazon-carousel-item<%= ' active' if index == 0 %>" data-index="<%= index %>">
      <a href="https://www.amazon.com/dp/<%= asin %>?tag=<%= sidebar.associate_id %>" target="_blank" rel="nofollow noopener">
        <div class="amazon-carousel-image">
          <img src="https://images-na.ssl-images-amazon.com/images/P/<%= asin %>.01._SCLZZZZZZZ_SX120_.jpg"
               alt="<%= h(info[:title] || 'Book cover') %>"
               onerror="this.onerror=null; if(!this.dataset.retry){this.dataset.retry='1';this.src='https://m.media-amazon.com/images/P/<%= asin %>.jpg';}else{this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22180%22><rect fill=%22%23f0f0f0%22 width=%22120%22 height=%22180%22 rx=%224%22/><text x=%2260%22 y=%2295%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22 font-family=%22sans-serif%22>Book</text></svg>';}">
<% if info[:audible] -%>
          <span class="amazon-audible-badge" title="Audiobook">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="white">
              <path d="M12 3c-4.97 0-9 4.03-9 9v7c0 1.1.9 2 2 2h2v-8H5v-1c0-3.87 3.13-7 7-7s7 3.13 7 7v1h-2v8h2c1.1 0 2-.9 2-2v-7c0-4.97-4.03-9-9-9z"/>
            </svg>
          </span>
<% end -%>
        </div>
        <span class="amazon-carousel-title"><%= h(info[:title] || "View Product") %></span>
      </a>
    </div>
<% end -%>
  </div>
<% if sidebar.products.size > 1 -%>
  <div class="amazon-carousel-nav">
    <button class="amazon-carousel-prev" aria-label="Previous">&lsaquo;</button>
    <div class="amazon-carousel-dots">
<% sidebar.products.each_with_index do |(asin, info), index| -%>
      <span class="amazon-carousel-dot<%= ' active' if index == 0 %>" data-index="<%= index %>"></span>
<% end -%>
    </div>
    <button class="amazon-carousel-next" aria-label="Next">&rsaquo;</button>
  </div>
<% end -%>
</div>
<script>
(function() {
  var carousel = document.querySelector('.amazon-carousel');
  if (!carousel || carousel.dataset.initialized) return;
  carousel.dataset.initialized = 'true';
  if (window.amazonCarouselInterval) {
    clearInterval(window.amazonCarouselInterval);
  }
  var items = carousel.querySelectorAll('.amazon-carousel-item');
  var dots = carousel.querySelectorAll('.amazon-carousel-dot');
  var prevBtn = carousel.querySelector('.amazon-carousel-prev');
  var nextBtn = carousel.querySelector('.amazon-carousel-next');
  var interval = parseInt(carousel.dataset.interval) || 5000;
  if (items.length <= 1) return;
  var current = 0;
  function show(index) {
    items.forEach(function(item, i) {
      item.classList.toggle('active', i === index);
    });
    dots.forEach(function(dot, i) {
      dot.classList.toggle('active', i === index);
    });
    current = index;
  }
  function next() {
    show((current + 1) % items.length);
  }
  function prev() {
    show((current - 1 + items.length) % items.length);
  }
  function startAutoplay() {
    window.amazonCarouselInterval = setInterval(next, interval);
  }
  function resetAutoplay() {
    clearInterval(window.amazonCarouselInterval);
    startAutoplay();
  }
  if (prevBtn) prevBtn.addEventListener('click', function() { prev(); resetAutoplay(); });
  if (nextBtn) nextBtn.addEventListener('click', function() { next(); resetAutoplay(); });
  dots.forEach(function(dot, i) {
    dot.addEventListener('click', function() { show(i); resetAutoplay(); });
  });
  carousel.addEventListener('mouseenter', function() { clearInterval(window.amazonCarouselInterval); });
  carousel.addEventListener('mouseleave', startAutoplay);
  startAutoplay();
})();
</script>
<% end -%>
